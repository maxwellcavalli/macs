from __future__ import annotations
from fastapi import FastAPI
from .sse_early_exit_mw import SSEEarlyExitMiddleware
from fastapi.middleware.cors import CORSMiddleware
from .api import router, hub
from .queue import JobQueue
from .logging_setup import setup_json_logging, get_logger
from .middleware import RequestIDMiddleware

setup_json_logging()
log = get_logger("bootstrap")

app = FastAPI(title="MACS API")



# Early-exit SSE when artifacts already exist
app.add_middleware(SSEEarlyExitMiddleware)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"], allow_credentials=True, allow_methods=["*"], allow_headers=["*"],
)
app.add_middleware(RequestIDMiddleware)

app.include_router(router)

@app.on_event("startup")
async def _startup():
    # create and start the queue
    jobq = JobQueue(hub)
    await jobq.start()
    # expose via app.state (authoritative)
    app.state.job_queue = jobq
    # also set module global for older call sites
    from . import api as api_module
    api_module.job_queue = jobq
    log.info("startup complete")

@app.get("/")
async def root():
    return {"ok": True, "service": "macs-api"}

# --- Bandit endpoints mounted on the FastAPI app (app-level) ---
try:
    from fastapi import HTTPException, Request
    from .bandit_store import record_event as _bandit_record_event, get_stats as _bandit_get_stats

    _app = globals().get("app")
    if _app is not None:
        async def _bandit_record(payload: dict):
            model = str(payload.get("model") or "unknown")
            try:
                reward = float(payload.get("reward"))
            except Exception:
                raise HTTPException(status_code=422, detail="reward must be a number")
            meta = payload.get("meta") or {}
            _bandit_record_event(model, reward, meta)
            return {"ok": True}

        async def _bandit_stats():
            return {"ok": True, "stats": _bandit_get_stats()}

        async def __debug_routes(request: Request):
            return {"routes": [getattr(r, "path", None) for r in request.app.routes]}

        _app.add_api_route("/v1/bandit/record", _bandit_record, methods=["POST"])
        _app.add_api_route("/v1/bandit/stats", _bandit_stats, methods=["GET"])
        _app.add_api_route("/v1/__debug/routes", __debug_routes, methods=["GET"])
except Exception:
    # Never break startup if optional endpoints fail
    pass
