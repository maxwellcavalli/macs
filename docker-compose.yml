version: "3.9"
name: macs

# Single file: API + Postgres + Ollama + Prometheus + Grafana
# Host ports:
# - API:      127.0.0.1:${API_HOST_PORT:-8080} -> 8080
# - Prom:     127.0.0.1:${PROM_HOST_PORT:-39090} -> 9090
# - Grafana:  127.0.0.1:${GRAFANA_HOST_PORT:-33000} -> 3000
# - Postgres: 127.0.0.1:${PG_HOST_PORT:-55432} -> 5432
# Ollama: internal-only (no host bind) to avoid 11434 conflicts.

services:
  postgres:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${PG_USER:-macs}
      POSTGRES_PASSWORD: ${PG_PASSWORD:-macs}
      POSTGRES_DB: ${PG_DB:-macs}
    ports:
      - "127.0.0.1:${PG_HOST_PORT:-55432}:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_USER:-macs} -d ${PG_DB:-macs}"]
      interval: 10s
      timeout: 5s
      retries: 10

  ollama:
    image: ollama/ollama:latest
    restart: unless-stopped
    # No host port (prevents conflicts on 11434)
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: ["gpu"]
    gpus: all
    environment:
      - OLLAMA_KEEP_ALIVE=24h
    volumes:
      - ollama_models:/root/.ollama
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:11434/api/tags >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 20

  api:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      ollama:
        condition: service_started
    environment:
      # ðŸ” REQUIRED for app startup
      - API_KEY=${API_KEY:-dev-local-change-me}
      # Internal wiring
      - DATABASE_URL=postgresql://${PG_USER:-macs}:${PG_PASSWORD:-macs}@postgres:5432/${PG_DB:-macs}
      - OLLAMA_HOST=http://ollama:11434
      - ARTIFACTS_DIR=/data/artifacts
      # Sensible defaults
      - RL_RPS=${RL_RPS:-5}
      - RL_BURST=${RL_BURST:-15}
      - SSE_EARLY_EXIT_ENABLED=${SSE_EARLY_EXIT_ENABLED:-1}
      - SSE_EARLY_EXIT_ACCEPT_ONLY=${SSE_EARLY_EXIT_ACCEPT_ONLY:-1}
      - SSE_EARLY_EXIT_REQUIRE_ID=${SSE_EARLY_EXIT_REQUIRE_ID:-1}
      - SSE_EARLY_EXIT_PATH_HINTS=${SSE_EARLY_EXIT_PATH_HINTS:-stream,events}
      - SSE_EARLY_EXIT_DIAGNOSTIC=${SSE_EARLY_EXIT_DIAGNOSTIC:-0}
    ports:
      - "127.0.0.1:${API_HOST_PORT:-8080}:8080"
    volumes:
      - artifacts:/data/artifacts
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080/health >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20

  prom_configgen:
    image: busybox:1.36
    restart: "no"
    volumes:
      - promconfig:/config
    entrypoint: ["/bin/sh","-lc"]
    command: |
      set -e
      mkdir -p /config
      cat > /config/prometheus.yml <<'EOF'
      global:
        scrape_interval: 15s
      scrape_configs:
        - job_name: "api"
          metrics_path: /metrics
          static_configs:
            - targets: ["api:8080"]
      EOF

  prometheus:
    image: prom/prometheus:v2.55.0
    restart: unless-stopped
    depends_on:
      prom_configgen:
        condition: service_completed_successfully
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.enable-lifecycle"
    ports:
      - "127.0.0.1:${PROM_HOST_PORT:-39090}:9090"
    volumes:
      - promdata:/prometheus
      - promconfig:/etc/prometheus:ro
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9090/-/ready"]
      interval: 10s
      timeout: 5s
      retries: 20

  grafana_provisioner:
    image: busybox:1.36
    restart: "no"
    volumes:
      - grafana_provisioning:/provisioning
    entrypoint: ["/bin/sh","-lc"]
    command: |
      set -e
      mkdir -p /provisioning/datasources
      cat > /provisioning/datasources/datasource.yml <<'EOF'
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          access: proxy
          url: http://prometheus:9090
          isDefault: true
      EOF

  grafana:
    image: grafana/grafana:11.2.2
    restart: unless-stopped
    depends_on:
      prometheus:
        condition: service_started
      grafana_provisioner:
        condition: service_completed_successfully
    ports:
      - "127.0.0.1:${GRAFANA_HOST_PORT:-33000}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:${GRAFANA_HOST_PORT:-33000}
    volumes:
      - grafana_data:/var/lib/grafana
      - grafana_provisioning:/etc/grafana/provisioning:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/api/health | grep -q healthy"]
      interval: 15s
      timeout: 5s
      retries: 20

volumes:
  pgdata:
  ollama_models:
  artifacts:
  promdata:
  promconfig:
  grafana_data:
  grafana_provisioning:
